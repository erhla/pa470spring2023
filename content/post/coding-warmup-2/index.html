---
title: "Coding Warmup 2"
date: 2023-01-26
categories: ["R"]
tags: ["warmup"]
publishdate: 2023-01-19
---



<p>This assignment is ungraded. I encourage you to review the problems to see if (1) you know how to do them or (2) if you know how to google how to do it. If either path forward escapes you, I suggest that you complete this assignment.</p>
<div id="part-0" class="section level1">
<h1>Part 0</h1>
<p>GitHub (and GitHub Classroom) tutorial. Accept the invitation <a href="https://classroom.github.com/a/oLQ628lN">here</a>.</p>
</div>
<div id="part-1" class="section level1">
<h1>Part 1</h1>
<p>Create an RMarkdown file to use for this assignment. Use html as the output and change at least one option in the yaml. Complete the rest of the assignment using markdown and chunks to create readable code and output.</p>
</div>
<div id="part-2" class="section level1">
<h1>Part 2</h1>
<p>Using <a href="censusreporter.org">censusreporter.org</a>, pick an American Community Survey variable and a geographic area and division (e.g. nationwide and states, statewide and county, county and tracts).</p>
<p>Using <code>tigris</code>, <code>tidycensus</code>, and <code>leaflet</code> (encouraged, or your favorite R package for maps), map the variable over your chosen geographic divisions. Select an appropriate pallete, and consider adding popup labels. Write a few sentences describing your map in Markdown.</p>
<pre class="r"><code>library(tidyverse)
library(tidycensus)
library(tigris)
library(sf)
library(scales)
library(leaflet)

il19 &lt;- get_acs(geography = &quot;tract&quot;, 
              variables = c(medincome = &quot;B19013_001&quot;,
                            totalpop = &quot;B02001_001&quot;,
                            white_alone = &quot;B02001_002&quot;,
                            black_alone = &quot;B02001_003&quot;,
                            asian_alone = &quot;B02001_004&quot;),
              state = &quot;IL&quot;, 
              year = 2019,
              output=&#39;wide&#39;)

il19 &lt;- il19 %&gt;% mutate(
  pct_white = white_aloneE / totalpopE,
  pct_black = black_aloneE / totalpopE,
  pct_asian = asian_aloneE / totalpopE
)

iltracts &lt;- tigris::tracts(state=&#39;17&#39;, year=2019, cb=TRUE)

joined &lt;- iltracts %&gt;% left_join(
  il19 %&gt;% select(GEOID, pct_white, totalpopE, medincomeE)
) %&gt;% filter(COUNTYFP == &#39;031&#39;) #cook

### make labels

label_str &lt;- str_glue(&quot;&lt;strong&gt;Tract %s&lt;/strong&gt;&lt;br&gt;White Alone (Pct): %s&lt;br/&gt;&quot;)
labels &lt;- sprintf(label_str,
                joined$NAME,
                percent(joined$pct_white, accuracy = .1)) %&gt;% 
  lapply(htmltools::HTML)

### make palette

pal1 &lt;-
  colorNumeric(
    palette = &quot;Oranges&quot;,
    domain = joined$pct_white,
    na.color = &quot;Grey&quot;
  )

  
m &lt;- leaflet() %&gt;%
  addTiles() %&gt;% addPolygons(
    data = joined,
    fillColor = ~ pal1(pct_white),
    weight = 0.5,
    opacity = 0.5,
    color = &quot;white&quot;,
    dashArray = 3,
    fillOpacity = 0.7,
    highlight = highlightOptions(
      weight = 5,
      color = &quot;#666&quot;,
      dashArray = &quot;&quot;,
      fillOpacity = 0.7,
      bringToFront = TRUE
    ),
    label = labels,
    labelOptions = labelOptions(
      style = list(&quot;font-weight&quot; = &quot;normal&quot;, padding = &quot;3px 8px&quot;),
      textsize = &quot;15px&quot;,
      direction = &quot;auto&quot;
    )
  ) %&gt;%
  addLegend(
    pal = pal1,
    values = joined$pct_white,
    opacity = 0.7,
    title = NULL,
    position = &quot;bottomright&quot;
  )
  

m
</code></pre>
</div>
<div id="part-3" class="section level1">
<h1>Part 3</h1>
<p>Grab another variable for the same geographic area and divisions with the intent of exploring correlation between this variable and the one selected in the previous section. Replicate some of the analysis from <a href="https://www.tmwr.org/base-r.html#an-example">Tidy Modeling Sec 3.1</a>.</p>
<pre class="r"><code>ggplot(joined, aes(x=pct_white, y=medincomeE)) +
  geom_point(alpha=.2) +
  geom_smooth() +
  theme_bw() +
  scale_y_continuous(labels=dollar_format()) +
  scale_x_continuous(labels = percent_format()) +
  labs(x=&#39;Percent White&#39;, y=&#39;Median Income&#39;, title=&#39;Income and Percent White (alone)\nby Tract in Cook County&#39;)</code></pre>
<pre class="r"><code>m1 &lt;- lm(medincomeE ~ pct_white + totalpopE, data=joined)

stargazer::stargazer(m1, type=&#39;html&#39;)</code></pre>
</div>
<div id="part-4" class="section level1">
<h1>Part 4</h1>
<p>Complete Exercise 12.3.3. Use <a href="https://github.com/DataScienceForPublicPolicy/build-simulation-data/blob/master/notebooks/raster-simulation.Rmd">this file</a> to simulate the data.</p>
<pre class="r"><code>
library(raster)
library(data.table)
library(tidyverse)

# Number of rows
nx = 50
ny = 50
# Set seed for reproducibility
set.seed(123)

#Generate data
#Create combination of all x and y values
# Create a random normal distribution
r1 = expand.grid(
  x = 1:nx,
  y = 1:ny
) %T&gt;%
setDT() %&gt;%
.[,val := rnorm(n = nx*ny, mean = x + y, sd = sqrt(ny))] %&gt;%
rasterFromXYZ()

r2 = expand.grid(
  x = 1:nx,
  y = 1:ny
) %T&gt;%
setDT() %&gt;%
.[,val := rnorm(n = nx*ny, mean = (-0.5) * x + 2 * y, sd = sqrt(ny))] %&gt;%
rasterFromXYZ()

r3 = expand.grid(
  x = 1:nx,
  y = 1:ny
) %T&gt;%
setDT() %&gt;%
.[,val := rnorm(n = nx*ny, mean = (1) * x - 1.25 * y, sd = sqrt(ny))] %&gt;%
rasterFromXYZ()

pop_r = expand.grid(
  x = 1:nx,
  y = 1:ny
) %T&gt;%
setDT() %&gt;%
.[,val := runif(n = nx*ny, min = 1, max = 100)] %&gt;%
rasterFromXYZ()
</code></pre>
<p>For each, we standardize the values.</p>
<pre class="r"><code># Force to same range: 1 to 100
r1 = r1 - cellStats(r1, min) + 1
r1 = 100 * r1 / cellStats(r1, max)
r2 = r2 - cellStats(r2, min) + 1
r2 = 100 * r2 / cellStats(r2, max)
r3 = r3 - cellStats(r3, min) + 1
r3 = 100 * r3 / cellStats(r3, max)

p1 = ggplot(data = as.data.frame(r1, xy = T)) +
  geom_raster(aes(x, y, fill = val)) +
  scale_fill_viridis_c(&quot;&quot;, option = &quot;magma&quot;) +
  guides(fill = guide_colourbar(barwidth = 1, barheight = 15)) +
  coord_equal() +
  theme_void() +
  ggtitle(&quot;r1&quot;) + 
  theme(legend.position = &quot;none&quot;, plot.title =  element_text(size=10, hjust = 0.5))

p2 = ggplot(data = as.data.frame(r2, xy = T)) +
  geom_raster(aes(x, y, fill = val)) +
  scale_fill_viridis_c(&quot;&quot;, option = &quot;magma&quot;) +
  guides(fill = guide_colourbar(barwidth = 1, barheight = 15)) +
  coord_equal() +
  theme_void() +
  ggtitle(&quot;r2&quot;) + 
theme(legend.position = &quot;none&quot;, plot.title =  element_text(size=10, hjust = 0.5))

p3 = ggplot(data = as.data.frame(r3, xy = T)) +
  geom_raster(aes(x, y, fill = val)) +
  scale_fill_viridis_c(&quot;&quot;, option = &quot;magma&quot;) +
  guides(fill = guide_colourbar(barwidth = 1, barheight = 15)) +
  coord_equal() +
  theme_void() + 
  ggtitle(&quot;r3&quot;) 
p3 = p3 + theme(legend.position = &quot;none&quot;, plot.title =  element_text(size=10, hjust = 0.5))

gridExtra::grid.arrange(p1, p2, p3, ncol = 3)

stack(r1, r2, r3) %&gt;% mean()

(r1+r2+r3) / 3


r_mean &lt;- stack(r1, r2, r3) %&gt;% mean()

p4 = ggplot(data = as.data.frame(r_mean, xy = T)) +
  geom_raster(aes(x, y, fill = layer)) +
  scale_fill_viridis_c(&quot;&quot;, option = &quot;magma&quot;) +
  guides(fill = guide_colourbar(barwidth = 1, barheight = 15)) +
  coord_equal() +
  theme_void() + 
  ggtitle(&quot;r4&quot;) 
p4 = p4 + theme(legend.position = &quot;none&quot;, plot.title =  element_text(size=10, hjust = 0.5))

p4
</code></pre>
</div>
<div id="part-5" class="section level1">
<h1>Part 5</h1>
<p>Consider expanding the divvy example from class with the following:</p>
<ul>
<li>approximate trip distance from start/end location</li>
<li>show some summary stats by hour or day of week or community area or “rideable” type</li>
<li>construct a regression with some combination of the above</li>
</ul>
<pre class="r"><code>temp &lt;- tempfile()
download.file(&quot;https://divvy-tripdata.s3.amazonaws.com/202107-divvy-tripdata.zip&quot;, 
              temp)
unzip(temp, list=TRUE)
divvy &lt;- read_csv(unz(temp, &quot;202107-divvy-tripdata.csv&quot;))
unlink(temp)</code></pre>
<pre class="r"><code>divvy &lt;- 
  divvy %&gt;% st_as_sf(coords=c(&quot;start_lng&quot;, &quot;start_lat&quot;), remove=FALSE)

st_crs(divvy) &lt;- 4326

divvy %&gt;% slice_sample(n=100) %&gt;%
  st_distance()

dist1 &lt;- divvy %&gt;% as.data.frame() %&gt;%
  filter(!is.na(start_lng)) %&gt;%
  rowwise() %&gt;%
  mutate(distance = geosphere::distHaversine(c(start_lng, start_lat), 
                                             c(end_lng, end_lat)))

ggplot(dist1 %&gt;% filter(distance/1609 &lt;= 7.5), aes(x=distance/1609)) +
  geom_histogram() +
  labs(x=&#39;Crow Distance (miles)&#39;,
       y=&#39;Rides&#39;,
       title=&#39;Divvy Distances July 2021 (Crow)&#39;)
</code></pre>
</div>
